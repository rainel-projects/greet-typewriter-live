<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Typewriter â€” Celestial Letter Edition</title>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lora:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
      --text: #f8f5ee;
      --accent: #f0d48a;
      --shadow-elevate: 0 4px 0 rgba(0,0,0,0.1), 0 6px 14px rgba(0,0,0,0.15);
      --bg-gradient: radial-gradient(circle at top, #0a0f12 0%, #111A19 100%);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Lora", serif;
      color: var(--text);
      line-height: 1.8;
      background: var(--bg-gradient);
      padding: 2rem;
      min-height: 100vh;
      background-attachment: fixed;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      text-align: center;
      animation: fadeIn 0.6s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    header.site-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid rgba(255,255,255,0.15);
      padding-bottom: .8rem;
      margin-bottom: 1.5rem;
      color: #f8f5ee;
    }

    .logo {
      width: 58px;
      height: 58px;
      background: var(--accent);
      display: grid;
      place-items: center;
      color: #111;
      font-family: "Playfair Display";
      font-size: 24px;
      font-weight: 700;
      box-shadow: var(--shadow-elevate);
      border-radius: 4px;
    }

    .site-title { font-family: "Playfair Display"; font-size: 1.7rem; }
    .muted { color: #e7e3d6; font-style: italic; font-size: .95rem; }

    .control-btn {
      background: var(--accent);
      border: none;
      color: #111;
      font-weight: 600;
      padding: .5rem .9rem;
      cursor: pointer;
      font-family: "Lora";
      border-radius: 4px;
      box-shadow: var(--shadow-elevate);
      transition: transform .15s ease, background .25s ease;
    }
    .control-btn:hover { transform: translateY(-2px); background: #809076; }

    .letter-frame {
      position: relative;
      background: url("./bg.png") center/cover no-repeat; /* âœ… Local background */
      border-radius: 8px;
      padding: 4rem 3rem;
      box-shadow: var(--shadow-elevate);
      overflow: hidden;
      min-height: 900px;
    }

    article.reader {
      position: relative;
      z-index: 2;
    }

    h1,h2 {
      font-family: "Playfair Display";
      font-weight: 600;
      color: var(--accent);
    }

    h1 { font-size: 2.3rem; margin-bottom: 1rem; }
    h2 { font-size: 1.5rem; margin-top: 1.8rem; }
    p { font-family: "Lora"; font-size: 1.08rem; margin: .8rem 0; color: #fffbe8; }

    .edit-icon {
      width: 18px; height: 18px; cursor: pointer;
      opacity: .7; margin-left: .4rem;
      transition: opacity .2s ease;
    }
    .edit-icon:hover { opacity: 1; }

    .editable[contenteditable="true"] {
      outline: 2px dashed rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1);
      transition: background 0.25s ease;
      border-radius: 4px;
    }

    .crud-actions {
      margin-top: 1.6rem;
      display: flex;
      gap: .8rem;
      justify-content: center;
    }

    .crud-btn {
      padding: .6rem 1.1rem;
      font-weight: 600;
      font-family: "Playfair Display";
      border: none;
      border-radius: 4px;
      box-shadow: var(--shadow-elevate);
      cursor: pointer;
      transition: transform .15s ease;
    }

    .add { background: var(--accent); color: #111; }
    .delete { background: #809076; color: #fffaf2; }
    .crud-btn:hover { transform: translateY(-2px); }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--accent);
      color: #111;
      padding: .6rem 1.2rem;
      box-shadow: var(--shadow-elevate);
      font-family: "Lora";
      font-weight: 600;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity .4s ease, transform .4s ease;
      border-radius: 4px;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
  </style>
</head>

<body>
  <div class="page">
    <header class="site-header">
      <div class="brand" style="display:flex;align-items:center;gap:.8rem;">
        <div class="logo">T</div>
        <div>
          <div class="site-title">Typewriter</div>
          <div class="muted">Celestial Letter Edition</div>
        </div>
      </div>
      <div class="controls">
        <button id="saveBtn" class="control-btn">Save</button>
        <button id="exportBtn" class="control-btn">Export Letter</button>
      </div>
    </header>

    <div class="letter-frame" id="letterFrame">
      <article class="reader" id="article">
        <h1 id="title" class="editable">
          Dear Friend,
          <svg class="edit-icon" viewBox="0 0 24 24" onclick="makeEditable('title')">
            <path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
          </svg>
        </h1>
        <p id="para1" class="editable">
          Wishing you warmth and peace beneath the same stars that guide our hearts.  
          May every word you read tonight carry a little moonlight of calm to your soul.
          <svg class="edit-icon" viewBox="0 0 24 24" onclick="makeEditable('para1')">
            <path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
          </svg>
        </p>
      </article>
    </div>

    <div class="crud-actions">
      <button class="crud-btn add" id="addSection">+ Add Section</button>
      <button class="crud-btn delete" id="deleteSection">Delete Last</button>
    </div>
  </div>

  <div id="toast" class="toast">Saved!</div>

  <script>
    const article = document.getElementById('article');
    const addSection = document.getElementById('addSection');
    const deleteSection = document.getElementById('deleteSection');
    const toast = document.getElementById('toast');
    const exportBtn = document.getElementById('exportBtn');
    const saveBtn = document.getElementById('saveBtn');
    let sectionCount = 1;

    addSection.onclick = () => {
      sectionCount++;
      const h2 = document.createElement("h2");
      h2.className = "editable";
      h2.id = `heading${sectionCount}`;
      h2.innerHTML = `New Reflection
        <svg class="edit-icon" viewBox="0 0 24 24" onclick="makeEditable('${h2.id}')">
          <path fill='currentColor' d='M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z'/></svg>`;
      const p = document.createElement("p");
      p.className = "editable";
      p.id = `para${sectionCount}`;
      p.innerHTML = `Write your reflection...
        <svg class="edit-icon" viewBox="0 0 24 24" onclick="makeEditable('${p.id}')">
          <path fill='currentColor' d='M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z'/></svg>`;
      article.appendChild(h2);
      article.appendChild(p);
      h2.setAttribute("contenteditable", "true");
      p.setAttribute("contenteditable", "true");
      h2.focus();
    };

    deleteSection.onclick = () => {
      const elements = article.querySelectorAll('.editable');
      if (elements.length > 2) elements[elements.length - 1].remove();
    };

    function makeEditable(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.setAttribute("contenteditable", "true");
      el.focus();
      el.style.outline = "2px dashed rgba(255,255,255,0.3)";
      el.style.background = "rgba(255,255,255,0.1)";
      const finishEdit = () => {
        el.removeAttribute("contenteditable");
        el.style.outline = "none";
        el.style.background = "transparent";
        el.removeEventListener("blur", finishEdit);
      };
      el.addEventListener("blur", finishEdit);
    }

    async function exportCardImage() {
      try {
        const letter = document.getElementById("letterFrame");
        const icons = letter.querySelectorAll(".edit-icon");
        icons.forEach(icon => icon.style.display = "none");

        const watermark = document.createElement("div");
        watermark.innerText = "ðŸ¤";
        Object.assign(watermark.style, {
          position: "absolute",
          top: "50%",
          left: "50%",
          transform: "translate(-50%, -50%)",
          fontFamily: "Playfair Display",
          fontSize: "280px",
          color: "rgba(255,255,255,0.07)",
          pointerEvents: "none",
          zIndex: "0"
        });
        letter.appendChild(watermark);

        const canvas = await html2canvas(letter, { scale: 3, useCORS: true });
        watermark.remove();
        icons.forEach(icon => icon.style.display = "inline");

        const link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = "Celestial_Typewriter_Letter.png";
        link.click();

        showToast("ðŸ’« Letter Image Exported!");
      } catch (err) {
        console.error("Export failed:", err);
        showToast("âŒ Export failed â€” check console.");
      }
    }

    saveBtn.onclick = () => {
      document.querySelectorAll(".editable").forEach(el => {
        el.removeAttribute("contenteditable");
        el.style.outline = "none";
        el.style.background = "transparent";
      });
      showToast("ðŸ’¾ All edits saved!");
    };

    exportBtn.onclick = exportCardImage;

    function showToast(msg) {
      toast.innerText = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2000);
    }
  </script>
</body>
</html>
